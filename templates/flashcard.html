<div class="flashcard-container">
    <div class="card-info">
        <span class="category">{{ card.category }}</span>
        <div class="home-button-center">
            <button onclick="location.href='/'" class="btn btn-secondary home-btn">
                üè† Home
            </button>
        </div>
        <div class="info-right">
            <span class="card-number">Card {{ session.current_card_index + 1 }} of {{ session.total_cards }}</span>
            {% if session.study_mode == 'timed' and session.time_limit > 0 %}
                {% set minutes = (session.time_remaining // 60) %}
                {% set seconds = (session.time_remaining % 60) %}
                <span class="timer" id="timer">‚è±Ô∏è {{ minutes }}:{{ "%02d"|format(seconds) }}</span>
            {% endif %}
            {% if session.study_mode == 'quick' %}
                <span class="mode-badge">‚ö° Quick Study</span>
            {% elif session.study_mode == 'timed' %}
                <span class="mode-badge">‚è±Ô∏è Timed Practice</span>
            {% elif session.study_mode == 'full_study' %}
                <span class="mode-badge">üìö Full Study</span>
            {% elif session.study_mode == 'flash_cards' %}
                <span class="mode-badge">üéØ Flash Cards</span>
            {% endif %}
            
            {% if session.topic_filter %}
                <span class="topic-badge">{{ session.topic_filter }}</span>
            {% else %}
                <span class="topic-badge">All Topics</span>
            {% endif %}
        </div>
    </div>
    
    <div class="flashcard" id="flashcard">
        <div class="flashcard-front" id="front">
            <h3>{{ card.question }}</h3>
        </div>
        <div class="flashcard-back" id="back" style="display: none;">
            <h4>Answer:</h4>
            <div class="answer-content">{{ card.answer | markdown | safe }}</div>
        </div>
    </div>
    
    <div class="card-controls">
        <!-- Navigation: Always visible for moving through cards and showing answers -->
        <div class="navigation-bar">
            {% if session.study_mode in ['quick', 'full_study'] %}
                <button hx-post="/prev-card-review"
                        hx-target="#flashcard-area"
                        hx-swap="innerHTML"
                        class="btn btn-secondary nav-btn"
                        id="prev-btn"
                        {% if session.current_card_index == 0 %}disabled{% endif %}>
                    Previous
                </button>
            {% else %}
                <button hx-get="/prev-card"
                        hx-target="#flashcard-area"
                        hx-swap="innerHTML"
                        class="btn btn-secondary nav-btn"
                        id="prev-btn"
                        {% if session.current_card_index == 0 %}disabled{% endif %}>
                    Previous
                </button>
            {% endif %}
            
            <button onclick="flipCard()" class="btn btn-info flip-btn" id="flip-btn">
                üîÑ Show Answer
            </button>
            
            {% if session.study_mode in ['quick', 'full_study'] %}
                <button hx-post="/next-card-review"
                        hx-target="#flashcard-area"
                        hx-swap="innerHTML"
                        class="btn btn-primary nav-btn"
                        id="next-btn">
                    Next
                </button>
            {% else %}
                <button hx-get="/next-card"
                        hx-target="#flashcard-area"
                        hx-swap="innerHTML"
                        class="btn btn-primary nav-btn"
                        id="next-btn">
                    Next
                </button>
            {% endif %}
        </div>
        
        {% if session.study_mode not in ['quick', 'full_study'] %}
            <!-- Scoring: Separate evaluation of your knowledge -->
            <div class="scoring-bar" id="scoring-controls" style="display: none;">
                <div class="scoring-label">How did you do?</div>
                <div class="scoring-buttons">
                    <button hx-post="/answer"
                            hx-vals='{"correct": "false"}'
                            hx-target="#stats"
                            hx-swap="innerHTML"
                            class="btn btn-wrong score-btn">
                        ‚ùå Incorrect
                    </button>
                    <button hx-post="/answer"
                            hx-vals='{"correct": "true"}'
                            hx-target="#stats" 
                            hx-swap="innerHTML"
                            class="btn btn-correct score-btn">
                        ‚úÖ Correct
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function flipCard() {
    const front = document.getElementById('front');
    const back = document.getElementById('back');
    const flipBtn = document.getElementById('flip-btn');
    const scoringControls = document.getElementById('scoring-controls');
    
    // Check current state and toggle
    if (front.style.display === 'none') {
        // Currently showing answer, flip to question
        front.style.display = 'block';
        back.style.display = 'none';
        flipBtn.innerHTML = 'üîÑ Show Answer';
        
        // Hide scoring when showing question
        if (scoringControls) {
            scoringControls.style.display = 'none';
        }
    } else {
        // Currently showing question, flip to answer
        front.style.display = 'none';
        back.style.display = 'block';
        flipBtn.innerHTML = 'üîÑ Show Question';
        
        // Show scoring controls for scoring modes (after showing answer)
        const modeBadge = document.querySelector('.mode-badge')?.textContent;
        if (scoringControls && !modeBadge?.includes('Quick Study') && !modeBadge?.includes('Full Study')) {
            scoringControls.style.display = 'block';
        }
    }
}

// Timer functionality for Timed Practice mode
let timerInterval = null;
let timeRemaining = 0;

function initTimer() {
    const timerElement = document.getElementById('timer');
    if (timerElement && timerElement.textContent.includes('‚è±Ô∏è')) {
        // Clear any existing timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Extract time from timer text (e.g., "‚è±Ô∏è 10:00")
        const timeText = timerElement.textContent.replace('‚è±Ô∏è ', '');
        const [minutes, seconds] = timeText.split(':');
        timeRemaining = parseInt(minutes) * 60 + parseInt(seconds);
        
        // Start countdown
        startTimer();
    }
}

function startTimer() {
    const timerElement = document.getElementById('timer');
    if (!timerElement) return;
    
    timerInterval = setInterval(() => {
        timeRemaining--;
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            timeUp();
            return;
        }
        
        // Update display
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is running low
        if (timeRemaining <= 60) {
            timerElement.style.background = '#e74c3c';
            timerElement.style.animation = 'pulse 1s infinite';
        } else if (timeRemaining <= 300) { // 5 minutes
            timerElement.style.background = '#f39c12';
        }
        
    }, 1000);
}

function timeUp() {
    alert('‚è∞ Time\'s up! Your timed practice session has ended.');
    window.location.href = '/';
}

// Initialize timer when page loads
document.addEventListener('DOMContentLoaded', initTimer);

// Restart timer after HTMX updates (for card transitions)
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Only restart timer if we're in timed mode
    if (evt.detail.target.id === 'flashcard-area') {
        setTimeout(initTimer, 100); // Small delay to ensure DOM is ready
    }
});

// Show next button after answering (for non-quick modes)
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.elt.hasAttribute('hx-post') && evt.detail.elt.getAttribute('hx-post') === '/answer') {
        const scoringControls = document.getElementById('scoring-controls');
        const stats = document.getElementById('stats');
        
        // Hide scoring controls after answering (user has made their choice)
        if (scoringControls) scoringControls.style.display = 'none';
        if (stats) stats.style.display = 'block';
        
        // Navigation (Next button) is always visible, no need to show/hide
    }
});
</script>